(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4169],{9488:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/bulletins/crops/special/create",function(){return t(2358)}])},2358:function(e,n,t){"use strict";t.r(n),t.d(n,{__N_SSG:function(){return F},default:function(){return H}});var r=t(4051),i=t.n(r),o=t(5893),l=t(7294),u=t(9473),a=t(7682),c=t(340),s=t(6383),f=t(5243),p=t(560),d=t(1029),v=t(1690),m=t(8152),y=t(4530),g=t(901),_=t(6490),b=t(3050),E=t(4463);function h(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function S(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function O(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,n){if(!e)return;if("string"===typeof e)return h(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return h(e,n)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,n,t){var r=(0,l.useState)([]),i=r[0],o=r[1];return(0,l.useEffect)((function(){if((null===e||void 0===e?void 0:e.data)&&(null===n||void 0===n?void 0:n.data)&&t.length>0&&0===i.length){var r=e.data.map((function(e){return e.province})).filter((function(e,n,t){return t.indexOf(e)===n})),l=e.data.reduce((function(e,n){return void 0===e[n.province]&&(e[n.province]=[]),e[n.province]=O(e[n.province]).concat(O(n.municipalities)),function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},r=Object.keys(t);"function"===typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),r.forEach((function(n){S(e,n,t[n])}))}return e}({},e)}),{}),u=O(t);u.forEach((function(n){n.disabled=!r.includes(n.label),n.municipalities.forEach((function(t){var r=e.data.findIndex((function(e){return e.province===t.province&&e.municipalities.includes(t.label)}));n.disabled?t.disabled=!0:(t.disabled=!l[n.label].includes(t.label),t.signal=r>-1?e.data[r].signal:0)}))})),o(u)}}),[e,n,t,i]),{affectedprovinces:i}}var A=t(8193),P=t(3766),I=t(1375),L=t(4640),C=t(6013),N=t(7392),j=t(7426),R=t(3063),D=t(2671),T=t(7661),k=t(7715);function M(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function B(e,n,t,r,i,o,l){try{var u=e[o](l),a=u.value}catch(c){return void t(c)}u.done?n(a):Promise.resolve(a).then(r,i)}function x(e){return function(){var n=this,t=arguments;return new Promise((function(r,i){var o=e.apply(n,t);function l(e){B(o,r,i,l,u,"next",e)}function u(e){B(o,r,i,l,u,"throw",e)}l(void 0)}))}}function G(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function W(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},r=Object.keys(t);"function"===typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),r.forEach((function(n){G(e,n,t[n])}))}return e}function Y(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,i,o=[],l=!0,u=!1;try{for(t=t.call(e);!(l=(r=t.next()).done)&&(o.push(r.value),!n||o.length!==n);l=!0);}catch(a){u=!0,i=a}finally{try{l||null==t.return||t.return()}finally{if(u)throw i}}return o}}(e,n)||function(e,n){if(!e)return;if("string"===typeof e)return M(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return M(e,n)}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var Z=function(e){return e&&"undefined"!==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};var K={sel_province:null,sel_municipality:null,sel_crop:null,sel_stage:null,sel_activity:[],sel_month:null,processed:!1,loading:!1,error:"",success:"",sel_condition:{id:0,from:"weather_condition",label:j.MW.WAY_BELOW_NORMAL.label}},U={url:"",filename:""};var F=!0,H=(0,f.Z)((function(e){var n=e.provinces,t=void 0===n?[]:n,r=e.user,f=e.onBtnLogoutClick,h=e.loading,S=(0,l.useState)(K),O=S[0],M=S[1],B=(0,l.useState)([]),F=B[0],H=B[1],V=(0,l.useState)([]),q=V[0],X=V[1],$=(0,l.useState)(null),z=$[0],J=$[1],Q=(0,L.Z)(O.sel_province,O.sel_municipality),ee=Q.days,ne=Q.loading,te=Q.error,re=Q.summary,ie=Y((0,a.ky)(d.K.GLOBAL_COLLECTIONS,d.K.CYCLONE_ADVISORY),2),oe=ie[0],le=ie[1],ue=Y((0,a.ky)(p.M.WEATHER_FORECASTS,"bicol/".concat(p.M.SUB_SPECIAL_COMMON,"/").concat(p.M.COMMON_SPECIAL_TYPE.WIND_SPEED)),2),ae=ue[0],ce=ue[1],se=w(ae,oe,t).affectedprovinces,fe=(0,P.Z)(O.sel_province,se),pe=(0,b.Z)(O.sel_province),de=pe.cropcalendar,ve=pe.loading,me=pe.error,ye=(0,_.Z)(de,O.sel_municipality),ge=(0,E.Z)(F,(0,k.aV)(!1),ye),_e=ge.cropslist,be=ge.uniquecropstages,Ee=ge.error,he=(0,A.Z)(z,null,C.q.SPECIAL,!0),Se=he.recommendations,Oe=he.farmoperations,we=he.loading,Ae=he.error,Pe=(0,I.Z)(Se),Ie=Pe.group,Le=Pe.error,Ce=(0,u.v9)((function(e){return e.reports})),Ne=Ce.status,je=Ce.report,Re=(0,u.v9)((function(e){return e.dashboard.reportType})),De=(0,u.v9)((function(e){return e.dashboard.isEnglish})),Te=(0,l.useState)(!0),ke=Te[0],Me=Te[1],Be=(0,l.useState)(!1),xe=Be[0],Ge=Be[1],We=(0,l.useRef)(!1),Ye=(0,l.useState)(""),Ze=Ye[0],Ke=Ye[1],Ue=(0,l.useState)(U),Fe=Ue[0],He=Ue[1],Ve=(0,l.useState)(N.BF),qe=Ve[0],Xe=Ve[1],$e=(0,u.I0)();(0,l.useEffect)((function(){return We.current=!0,function(){We.current=!1}}),[]),(0,l.useEffect)((function(){$e((0,y.Km)([])),$e((0,D.s_)())}),[$e]),(0,l.useEffect)((function(){null!==re&&M((function(e){return W({},e,{sel_month:{label:(0,k.aV)()}})}))}),[re]),(0,l.useEffect)((function(){Me(h||ve||we||ne||le===g.G.PENDING||ce===g.G.PENDING)}),[h,ve,we,ne,le,ce]),(0,l.useEffect)((function(){He(U)}),[De]),(0,l.useEffect)((function(){if(""!==me||""!==Ae||""!==te||""!==Ee){var e=me||Ae||te||Ee;M((function(n){return W({},n,{error:e})}))}else M((function(e){return W({},e,{error:""})}))}),[Ee,Ae,te,me]),(0,l.useEffect)((function(){null===O.sel_municipality||ne||le===g.G.PENDING||Ke((function(e){var n,t,r,i;return(0,T.smsWriter)({type:T.SMS_TYPE.SPECIAL,replacements:(i={},G(i,T.REPLACE_KEYS.SPECIAL.TYPHOON_NAME,(null===oe||void 0===oe||null===(n=oe.meta)||void 0===n?void 0:n.typhoon_name)||"-"),G(i,T.REPLACE_KEYS.SPECIAL.TYPHOON_SIGNAL,(null===O||void 0===O||null===(t=O.sel_municipality)||void 0===t?void 0:t.signal)||0),G(i,T.REPLACE_KEYS.SPECIAL.MUNICIPALITY,(null===O||void 0===O||null===(r=O.sel_municipality)||void 0===r?void 0:r.label)||"-"),i)})}))}),[ee,ne,oe,le,O.sel_municipality]),(0,l.useEffect)((function(){Ne===g.G.FULLFILLED&&null!==je&&We.current&&Xe((function(e){return W({},e,{msg:"Success! Bulletin report created.",loading:!1,savesuccess:!0,docId:je.id})}))}),[Ne,je]),(0,l.useEffect)((function(){Le||null===Ie||$e((0,y.Km)(Ie))}),[Ie,Le,$e]),(0,l.useEffect)((function(){if(!h)if(be.length>0){var e=be.map((function(e){return e.code})).toString(),n=be.map((function(e){return e.label})).toString();J(e),M((function(e){return W({},e,{sel_crop:_e.map((function(e){return e.label})).toString().split(",").join(", "),sel_stage:n})}))}else $e((0,y.Km)([])),null!==O.sel_municipality&&M((function(e){return W({},e,{error:"No crop stages are available for this date on ".concat(e.sel_municipality,".")})}))}),[be,_e,h,,$e]);var ze=function(){var e=x(i().mark((function e(){var n,t,r,o,l;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""===Fe.url){e.next=3;break}return Ge(!0),e.abrupt("return");case 3:return M((function(e){return W({},e,{loading:!0,error:"",success:""})})),e.prev=4,n={region:"bicol",province:O.sel_province,municipality:O.sel_municipality,date:(new Date).toDateString(),operation:"preview",language:De?"en":"tag"},Ge(!0),M((function(e){return W({},e,{loading:!0,error:""})})),e.next=10,(0,m.U1)(n);case 10:t=e.sent,r=new Blob([t],{type:"application/pdf"}),(o={}).href=URL.createObjectURL(r),o.download="".concat(O.sel_province,"_").concat(O.sel_municipality,".pdf"),He((function(e){return W({},e,{url:o.href,filename:o.download})})),M((function(e){return W({},e,{loading:!1,success:"Bulletin preview created."})})),e.next=25;break;case 19:e.prev=19,e.t0=e.catch(4),l="",void 0!==e.t0.response&&(l=void 0!==e.t0.response.data&&"[object Blob]"===Z(e.t0.response.data)?e.t0.response.data:""),""===l&&(l=e.t0.message),M((function(e){return W({},e,{loading:!1,error:l})}));case 25:case"end":return e.stop()}}),e,null,[[4,19]])})));return function(){return e.apply(this,arguments)}}(),Je=function(){var e=x(i().mark((function e(){var n,t;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Xe(W({},qe,{loading:!0,msg:"Saving report..."}));try{n={region:"bicol",province:O.sel_province,municipality:O.sel_municipality,date:(new Date).toDateString(),operation:"create",language:De?"en":"tag"},$e((0,v.tR)(n)).unwrap().then((function(){Re!==N.Ry.SPECIAL_WEATHER&&($e((0,R.uq)(N.Ry.SPECIAL_WEATHER)),$e((0,v.RC)({uid:r.uid,type:N.Ry.SPECIAL_WEATHER})))})).catch((function(e){We.current&&Xe((function(n){return W({},n,{msg:e,loading:!1,savesuccess:!1,docId:null})}))}))}catch(i){t="",void 0!==i.response&&(t=void 0!==i.response.data&&"[object Blob]"===Z(i.response.data)?i.response.data:""),""===t&&(t=i.message),M((function(e){return W({},e,{loading:!1,error:t})}))}case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,o.jsx)(s.Z,{loading:h,user:r,onBtnLogoutClick:f,accLevel:j.DW.ADMIN,children:(0,o.jsx)(c.Z,{optsprovinces:se,optsmunicipalities:fe,optscrops:_e,optscropstages:be,optsactivities:Oe,sel_options:O,loading:ke,isloadingreport:Ne===g.G.PENDING,open:xe,message:qe,smstext:Ze,pageTitle:"Special Weather Bulletin",pageDescription:"Create <strong>Special Weather</strong> crop recommendations bulletins. Finalized bulletins will be automatically uploaded to the site for public download.",pdfPreview:Fe,onSelectItemChange:function(e,n){var t=n.from,r=n.label;if(He(U),q.length>0&&X([]),""!==O.error&&M((function(e){return W({},e,{error:""})})),Object.keys(n).includes("id"))switch(t){case"province":J(null),M((function(e){return W({},e,{sel_province:r,sel_municipality:null,sel_crop:null,sel_stage:null,sel_activity:null})}));break;case"municipality":J(null),M((function(e){return W({},e,{sel_municipality:r,sel_crop:null,sel_stage:null,sel_activity:null})})),H(de.filter((function(e){return e.municipality===r})))}else if("province"===t){var i=O.sel_month;M(W({},K,{sel_month:i})),J(null)}else"municipality"===t&&(M(W({},O,{sel_municipality:null,sel_crop:null,sel_day:null,sel_stage:null,sel_activity:null})),J(null))},handlePreview:ze,handleSave:Je,toggleViewerOpen:function(){Ge((function(e){return!e}))},resetSelections:function(){var e=O.sel_month;M(W({},K,{sel_month:e})),J(null),$e((0,y.Km)([]))},togglePrompt:function(){Xe((function(e){return W({},N.BF,{isOpen:!e.isOpen})}))}})})}))}},function(e){e.O(0,[6284,2866,9964,9522,1903,7823,6295,4039,2882,7092,6572,1050,6454,3523,7702,1241,9774,2888,179],(function(){return n=9488,e(e.s=n);var n}));var n=e.O();_N_E=n}]);